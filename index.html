<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Impostor - Multijugador</title>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for inline JSX (dev convenience) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (v9 compat CDN for easier single-file use) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
    body { font-family: 'Poppins', sans-serif; background: #0b1020; color: #e6eef8; margin:0; -webkit-font-smoothing:antialiased; }
    .card-container { perspective:1200px; }
    .game-card { transform-style:preserve-3d; will-change:transform; touch-action:none; user-select:none; }
    .card-snap-back { transition: transform 300ms cubic-bezier(.22,.9,.28,1); }
    @keyframes bounce-up { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
    .animate-bounce-custom { animation: bounce-up 1.4s infinite; }
    .no-scrollbar::-webkit-scrollbar{display:none} .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
/* ------------------------------
  Impostor Multijugador (Single File)
  - Usa Firebase Realtime Database (compat)
-------------------------------*/

const { useState, useEffect, useRef } = React;

/* ---------------------- CONFIG ---------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDRGRi_Npt30Q7WfyhipyGXyk8vAeZrlCQ",
  authDomain: "impostor-5803d.firebaseapp.com",
  projectId: "impostor-5803d",
  databaseURL: "https://impostor-5803d-default-rtdb.firebaseio.com",
  messagingSenderId: "12633602652",
  appId: "1:12633602652:web:67cef779b6090b50194499",
  measurementId: "G-8575W3YWL3"
};

/* ---------------------- Setup Firebase ---------------------- */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* ---------------------- Datos locales ---------------------- */
const wordCategories = [
  { category: "Lugares", words: ["Hospital", "Escuela", "Playa", "Aeropuerto", "Cine", "Cementerio", "Biblioteca", "Gimnasio"] },
  { category: "Comida", words: ["Pizza", "Sushi", "Hamburguesa", "Tacos", "Helado", "Chocolate", "Ensalada", "Paella"] },
  { category: "Animales", words: ["Elefante", "Jirafa", "Le√≥n", "Ping√ºino", "Delf√≠n", "Perro", "Gato", "Koala"] },
  { category: "Objetos", words: ["Tel√©fono", "Cuchara", "Reloj", "Silla", "L√°mpara", "Zapato", "Guitarra", "Espejo"] },
  { category: "Profesiones", words: ["Doctor", "Polic√≠a", "Bombero", "Profesor", "Astronauta", "Cocinero", "Payaso", "Mec√°nico"] }
];
const avatars = ["üëΩ","üëª","ü§ñ","ü§°","üëπ","ü§†","üòé","ü¶Ñ","üê≤","üéÉ","üêØ","üê∂","ü¶ä","ü¶Å"];

/* ---------------------- Utils ---------------------- */
const uidKey = 'impostor_uid_v2';
const playerLSkey = 'impostor_player_v2';
const roomLSkey = 'impostor_room_v2';

function makeRoomId() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s='';
  for(let i=0;i<4;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

function saveLS(key, value){ try{ localStorage.setItem(key, JSON.stringify(value)); } catch(e){} }
function loadLS(key, fallback){ try { const v = localStorage.getItem(key); return v?JSON.parse(v):fallback;}catch(e){return fallback;} }

/* ---------------------- Authentication: Anonymous ---------------------- */
async function ensureAuth() {
  let user = auth.currentUser;
  if (!user) {
    try {
      const result = await auth.signInAnonymously();
      user = result.user;
      saveLS(uidKey, user.uid);
    } catch (err) {
      console.error('Auth error', err);
      let fallbackId = loadLS(uidKey, null);
      if (!fallbackId) {
        fallbackId = 'anon_' + Math.random().toString(36).slice(2,10);
        saveLS(uidKey, fallbackId);
      }
      return { uid: fallbackId, fallback:true };
    }
  }
  return { uid: user.uid, fallback:false };
}

/* ---------------------- Helper UI components (EXTRA√çDOS FUERA DE APP PARA EVITAR RE-RENDER BUG) ---------------------- */

function HomeView({ me, setMe, createRoom, joinRoom, roomId }){
  const [joinCode, setJoinCode] = useState('');
  // Usamos me.name directamente para unirse si no se escribe otro
  const [joinName, setJoinName] = useState(me ? me.name : '');

  return (
    <div className="min-h-screen flex flex-col p-6 items-center justify-start">
      <div className="text-center mt-6">
        <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">IMPOSTOR</h1>
        <p className="text-gray-300 mt-1">Multijugador ‚Äî crea o √∫nete a una sala</p>
      </div>

      <div className="w-full max-w-md mt-8 space-y-4">
        <div className="bg-[#0f1724] p-4 rounded-xl border border-gray-800">
          <div className="font-semibold mb-2">Tu perfil</div>
          <div className="flex items-center gap-3">
            <div className="text-3xl">{me && me.avatar}</div>

            {/* Input corregido: Al estar HomeView fuera de App, el foco se mantiene */}
            <input
              value={me ? me.name : ''}
              onChange={(e)=>{
                const nm = e.target.value;
                const newMe = {...me, name:nm};
                setMe(newMe);
                saveLS(playerLSkey, newMe);
              }}
              className="bg-transparent border-b border-gray-700 focus:outline-none flex-1 py-1"
            />
          </div>
          <div className="text-xs text-gray-400 mt-2">Tu sesi√≥n es an√≥nima. Usa un nombre para que tus amigos te reconozcan.</div>
        </div>

        <button onClick={createRoom} className="w-full py-3 rounded-xl bg-gradient-to-r from-green-400 to-blue-500 text-black font-bold">Crear sala</button>

        <div className="bg-[#0f1724] p-3 rounded-xl border border-gray-800">
          <div className="font-semibold mb-2">Unirse a sala</div>
          <input value={joinCode} onChange={(e)=>setJoinCode(e.target.value.toUpperCase())} placeholder="C√≥digo de sala (ej: 4L3X)" className="w-full p-3 mb-2 rounded bg-[#0b1220] border border-gray-700" />
          <button onClick={()=>joinRoom(joinCode, joinName || (me && me.name))} className="w-full py-2 rounded-lg bg-white/10">Unirse</button>
          <div className="text-xs text-gray-400 mt-2">Si el host ya cre√≥ la sala, introduce el c√≥digo y √∫nete.</div>
        </div>

        <div className="text-xs text-gray-500 text-center mt-Vers√≠on (1.04): <strong>{roomId || '-'}</strong></div>
      </div>
    </div>
  );
}

/* ---------------------- App Component ---------------------- */
function App(){
  const [ready, setReady] = useState(false);
  const [me, setMe] = useState(loadLS(playerLSkey, null)); 
  const [roomId, setRoomId] = useState(loadLS(roomLSkey, null));
  const [view, setView] = useState('home'); 
  const [roomState, setRoomState] = useState(null); 
  const [players, setPlayers] = useState([]); 
  const [localRole, setLocalRole] = useState(null); 
  const [secretWord, setSecretWord] = useState('');
  const [category, setCategory] = useState('');
  const [isHost, setIsHost] = useState(false);

  // Refs para swipe y l√≥gica de juego
  const cardFrontRef = useRef(null);
  const containerRef = useRef(null);
  const startYRef = useRef(0);
  const translateRef = useRef(0);
  const draggingRef = useRef(false);
  const [cardRevealed, setCardRevealed] = useState(false);
  const [showNext, setShowNext] = useState(false);
  const [containerHeight, setContainerHeight] = useState(420);
  const THRESHOLD_RATIO = 0.5;

  const roomRef = useRef(null);
  const playersRef = useRef(null);
  const gameRef = useRef(null);

  // Auth init
  useEffect(()=> {
    (async ()=> {
      const authRes = await ensureAuth();
      let myPlayer = me;
      if (!myPlayer) {
        const name = 'Jugador ' + Math.floor(Math.random()*900+100);
        const avatar = avatars[Math.floor(Math.random()*avatars.length)];
        myPlayer = { uid: authRes.uid, name, avatar };
        saveLS(playerLSkey, myPlayer);
        setMe(myPlayer);
      } else {
        myPlayer.uid = authRes.uid || myPlayer.uid;
        saveLS(playerLSkey, myPlayer);
        setMe(myPlayer);
      }
      setReady(true);
    })();
  }, []);

  useEffect(() => {
    const update = () => {
      const el = containerRef.current;
      if (el) {
        const r = el.getBoundingClientRect();
        setContainerHeight(r.height || 420);
      }
    };
    update();
    window.addEventListener('resize', update);
    return ()=> window.removeEventListener('resize', update);
  }, []);

  useEffect(()=> {
    if (!ready) return;
    cleanupRoomListeners();
    if (!roomId) {
      setRoomState(null);
      setPlayers([]);
      setView('home');
      saveLS(roomLSkey, null);
      return;
    }
    roomRef.current = db.ref('rooms/' + roomId);
    playersRef.current = db.ref('rooms/' + roomId + '/players');
    gameRef.current = db.ref('rooms/' + roomId + '/game');

    roomRef.current.child('meta').on('value', snap => {
      const val = snap.val();
      setRoomState(prev => ({ ...prev, meta: val }));
      if (val && val.hostUid === (me && me.uid)) setIsHost(true); else setIsHost(false);
    });

    playersRef.current.on('value', snap => {
      const obj = snap.val() || {};
      const arr = Object.keys(obj).map(k => ({ uid: k, ...obj[k] }));
      arr.sort((a,b) => (a.joinedAt||0) - (b.joinedAt||0));
      setPlayers(arr);
      setRoomState(prev => ({ ...prev, players: obj }));
    });

    gameRef.current.on('value', snap => {
      const val = snap.val();
      setRoomState(prev => ({ ...prev, game: val }));
      if (val) {
        setCategory(val.category || '');
        setSecretWord(val.word || '');
        if (val.state === 'playing') {
          setView('game');
          if (val.roles && me && me.uid) {
            const myRole = val.roles[me.uid] ? val.roles[me.uid].role : null;
            setLocalRole(myRole);
          } else {
            setLocalRole(null);
          }
        } else if (val.state === 'finished') {
          setView('finished');
        } else {
          setView('lobby');
        }
      } else {
        setView('lobby');
      }
    });

    saveLS(roomLSkey, roomId);
    return () => cleanupRoomListeners();
  }, [roomId, ready, me && me.uid]);

  function cleanupRoomListeners() {
    if (roomRef.current) { roomRef.current.off(); roomRef.current = null; }
    if (playersRef.current) { playersRef.current.off(); playersRef.current = null; }
    if (gameRef.current) { gameRef.current.off(); gameRef.current = null; }
  }

  async function createRoom() {
    const id = makeRoomId();
    const meta = { hostUid: me.uid, createdAt: Date.now() };
    await db.ref('rooms/' + id + '/meta').set(meta);
    await db.ref('rooms/' + id + '/players/' + me.uid).set({ name: me.name, avatar: me.avatar, joinedAt: Date.now() });
    await db.ref('rooms/' + id + '/game').set({ state: 'lobby' });
    setRoomId(id);
    setIsHost(true);
    setView('lobby');
  }

  async function joinRoom(code, nameOverride) {
    if (!code) return alert('C√≥digo vac√≠o');
    const roomSnap = await db.ref('rooms/' + code + '/meta').get();
    if (!roomSnap.exists()) return alert('Sala no encontrada: verifica el c√≥digo');
    const playerName = nameOverride || me.name;
    await db.ref('rooms/' + code + '/players/' + me.uid).set({ name: playerName, avatar: me.avatar, joinedAt: Date.now() });
    setRoomId(code);
    setView('lobby');
  }

  async function leaveRoom() {
    if (!roomId) return;
    await db.ref('rooms/' + roomId + '/players/' + me.uid).remove();
    const metaSnap = await db.ref('rooms/' + roomId + '/meta').get();
    const meta = metaSnap.val();
    if (meta && meta.hostUid === me.uid) {
      const playersSnap = await db.ref('rooms/' + roomId + '/players').get();
      const obj = playersSnap.val() || {};
      const uids = Object.keys(obj);
      if (uids.length === 0) {
        await db.ref('rooms/' + roomId).remove();
      } else {
        const newHostUid = uids[0];
        await db.ref('rooms/' + roomId + '/meta/hostUid').set(newHostUid);
      }
    }
    setRoomId(null);
    setView('home');
    saveLS(roomLSkey, null);
  }

  async function hostStartGame(settings = {}) {
    if (!isHost) return alert('Solo el host puede iniciar la partida');
    const catIdx = Math.floor(Math.random() * wordCategories.length);
    const cat = wordCategories[catIdx];
    const word = cat.words[Math.floor(Math.random()*cat.words.length)];
    const playersSnap = await db.ref('rooms/' + roomId + '/players').get();
    const playersObj = playersSnap.val() || {};
    const uids = Object.keys(playersObj);
    if (uids.length < 3) return alert('Se necesitan al menos 3 jugadores para iniciar');
    
    const historySnap = await db.ref('rooms/' + roomId + '/meta/history').get();
    const history = historySnap.exists() ? historySnap.val() : [];
    const recallN = settings.recallRounds || 3;
    const penalty = settings.penaltyPerRecent || 0.6;

    const weights = uids.map(uid => 1);
    const lastN = history.slice(-recallN);
    uids.forEach((uid,i) => {
      const times = lastN.filter(x => x === uid).length;
      if (times>0) weights[i] = weights[i] * Math.pow(1 - penalty, times);
    });
    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum;
    let chosenIdx = 0;
    for (let i=0;i<weights.length;i++){
      r -= weights[i];
      if (r <= 0) { chosenIdx = i; break;}
    }
    const impostorUid = uids[chosenIdx];

    const roles = {};
    for (let u of uids) {
      roles[u] = { role: (u === impostorUid ? 'impostor' : 'word') };
    }

    await db.ref('rooms/' + roomId + '/game').set({
      state: 'playing',
      category: cat.category,
      word: word,
      startedAt: Date.now(),
      impostorUid,
      roles,
    });

    const nextHistory = (history||[]).concat([impostorUid]).slice(-50);
    await db.ref('rooms/' + roomId + '/meta/history').set(nextHistory);
  }

  async function hostFinishGame() {
    if (!isHost) return;
    await db.ref('rooms/' + roomId + '/game/state').set('finished');
  }

  // Swipe logic
  const THRESHOLD = useRef(0);
  useEffect(()=> { THRESHOLD.current = -Math.round(containerHeight * THRESHOLD_RATIO); }, [containerHeight]);

  function onPointerDown(ev){
    if (view !== 'game' || cardRevealed) return;
    draggingRef.current = true;
    startYRef.current = ev.clientY ?? (ev.touches && ev.touches[0] && ev.touches[0].clientY) ?? 0;
    translateRef.current = 0;
    setShowNext(true);
  }
  function onPointerMove(ev){
    if (!draggingRef.current || view !== 'game' || cardRevealed) return;
    const clientY = ev.clientY ?? (ev.touches && ev.touches[0] && ev.touches[0].clientY) ?? 0;
    const delta = clientY - startYRef.current;
    const translateY = Math.min(0, delta);
    translateRef.current = translateY;
    if (cardFrontRef.current) {
      cardFrontRef.current.style.transition = 'transform 0ms';
      const scale = 1 - Math.min(0.07, Math.abs(translateY)/(containerHeight*6));
      cardFrontRef.current.style.transform = `translateY(${translateY}px) scale(${scale})`;
    }
    if (translateY <= THRESHOLD.current) {
      draggingRef.current = false;
      revealLocalCard();
    }
  }
  function onPointerUp(ev){
    if (cardRevealed) return;
    if (!draggingRef.current) return;
    draggingRef.current = false;
    if (translateRef.current > THRESHOLD.current) {
      snapBackLocal();
    } else {
      revealLocalCard();
    }
  }
  function revealLocalCard(){
    setCardRevealed(true);
    setShowNext(true);
    if (cardFrontRef.current) {
      cardFrontRef.current.style.transition = 'transform 320ms cubic-bezier(.22,.9,.28,1)';
      cardFrontRef.current.style.transform = `translateY(${THRESHOLD.current - 80}px) scale(1.02)`;
    }
  }
  function snapBackLocal(){
    if (cardFrontRef.current) {
      cardFrontRef.current.classList.add('card-snap-back');
      cardFrontRef.current.style.transform = 'translateY(0px) scale(1)';
      setTimeout(()=> { if (cardFrontRef.current) cardFrontRef.current.classList.remove('card-snap-back'); }, 320);
    }
    setShowNext(true);
  }

  async function playerRevealDone() {
    if (roomId) await db.ref('rooms/' + roomId + '/players/' + me.uid + '/ready').set(true);
  }
  async function playerResetReady() {
    if (roomId) await db.ref('rooms/' + roomId + '/players/' + me.uid + '/ready').set(false);
  }
  async function hostResetReadyAll() {
    if (!isHost) return;
    const snap = await db.ref('rooms/' + roomId + '/players').get();
    const obj = snap.val() || {};
    const updates = {};
    Object.keys(obj).forEach(uid => updates[uid + '/ready'] = false);
    await db.ref('rooms/' + roomId + '/players').update(updates);
  }

  // --- Vistas internas (Estas no tienen inputs que re-rendericen App, as√≠ que se pueden quedar aqu√≠ o sacarse tambi√©n) ---
  // Nota: Para arreglar el bug principal (input de nombre), bastaba con sacar HomeView.

  function LobbyView(){
    return (
      <div className="min-h-screen flex flex-col p-6 items-center">
        <div className="w-full max-w-md">
          <div className="flex items-center justify-between mb-4">
            <div>
              <div className="text-xs text-gray-400">Sala</div>
              <div className="text-2xl font-bold">{roomId}</div>
            </div>
            <div>
              <div className="text-xs text-gray-400">Host</div>
              <div className="text-sm">{roomState && roomState.meta && roomState.meta.hostUid === me.uid ? 'T√∫' : 'Otro'}</div>
            </div>
          </div>

          <div className="bg-[#0f1724] p-4 rounded-xl border border-gray-800 mb-4">
            <div className="font-semibold mb-2">Jugadores</div>
            <div className="space-y-2">
              {players.map(p => (
                <div key={p.uid} className="flex items-center justify-between bg-[#0b1220] p-2 rounded">
                  <div className="flex items-center gap-3">
                    <div className="text-2xl">{p.avatar}</div>
                    <div>
                      <div className="font-semibold">{p.name}</div>
                      <div className="text-xs text-gray-400">{p.uid === me.uid ? 'T√∫' : ''}</div>
                    </div>
                  </div>
                  <div className="text-xs text-gray-400">{p.ready ? 'Listo' : '‚Äî'}</div>
                </div>
              ))}
            </div>
          </div>

          <div className="flex gap-2 mb-3">
            <button onClick={() => { if (isHost) hostStartGame(); else alert('Solo el host puede iniciar'); }} className="flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 font-bold">INICIAR PARTIDA</button>
            <button onClick={leaveRoom} className="py-3 px-4 rounded-xl bg-white/10">Salir</button>
          </div>

          <div className="text-xs text-gray-400">Comparte este c√≥digo con tus amigos para que se unan: <strong>{roomId}</strong></div>
        </div>
      </div>
    );
  }

  function GameView(){
    const currentPlayer = players.find(p => p.uid === me.uid) || me;
    const isImpostor = localRole === 'impostor';
    return (
      <div className="min-h-screen flex flex-col p-5 items-center">
        <div className="absolute top-6 left-0 right-0 flex justify-center gap-2 px-6">
          <div className="h-1.5 w-40 rounded-full bg-white" />
        </div>

        <div className="text-center mb-6 mt-8 z-10">
          <h2 className="text-gray-400 text-sm uppercase tracking-widest mb-1">Sala {roomId}</h2>
          <h1 className="text-3xl font-bold">{currentPlayer.name}</h1>
        </div>

        <div ref={containerRef} className="w-full max-w-xs h-96 relative card-container z-20" 
             onPointerDown={onPointerDown} onPointerMove={onPointerMove} onPointerUp={onPointerUp} onPointerCancel={onPointerUp}>
          <div ref={cardFrontRef} className={`game-card absolute inset-0 rounded-3xl border-2 border-gray-700 flex flex-col items-center justify-center bg-gradient-to-br from-[#0f1724] to-[#0b1220] cursor-grab ${cardRevealed ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
            <div className="text-8xl mb-3">{currentPlayer.avatar}</div>
            <div className="text-gray-300 font-medium text-center px-6">
              <p className="mb-2">Hola <span style={{color:'#a78bfa', fontWeight:700}}>{currentPlayer.name}</span></p>
              <p className="text-sm opacity-70">Desliza hacia arriba hasta la mitad para ver tu rol secreto</p>
            </div>
            <div className="absolute bottom-6 animate-bounce-custom opacity-60">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 19V5M5 12l7-7 7 7"/>
              </svg>
            </div>
          </div>

          <div className={`absolute inset-0 flex flex-col items-center justify-center rounded-3xl border-4 transition-all duration-500 ${cardRevealed ? 'scale-100 opacity-100 block' : 'scale-90 opacity-0 hidden'} ${isImpostor ? 'bg-red-900/20 border-red-500' : 'bg-blue-900/20 border-blue-500'}`}>
            {isImpostor ? (
              <div className="text-center animate-pulse">
                <div className="text-6xl mb-4">ü§´</div>
                <h2 className="text-3xl font-black text-red-500 mb-2">IMPOSTOR</h2>
                <p className="text-red-200 px-4 text-sm">Enga√±a a todos. No conoces la palabra.</p>
              </div>
            ) : (
              <div className="text-center">
                <div className="text-6xl mb-4">üîí</div>
                <h2 className="text-lg font-medium text-blue-300 mb-1">La palabra es:</h2>
                <h1 className="text-4xl font-black text-white tracking-wide mb-4">{secretWord}</h1>
                <div className="text-xs text-gray-400 mt-3">Categor√≠a: {category}</div>
              </div>
            )}
          </div>
        </div>

        <div className={`w-full max-w-xs mt-6 transition-all duration-300 transform ${showNext ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-6 pointer-events-none'}`}>
          <button onClick={async (e)=>{ e.stopPropagation(); playerRevealDone(); }} 
                  disabled={!cardRevealed}
                  className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-3 ${cardRevealed ? 'bg-white text-gray-900' : 'bg-white/20 text-gray-400 opacity-70 cursor-not-allowed'}`}>
            <span style={{fontSize:'1.4rem'}}>{currentPlayer.avatar}</span>
            <span>ENTENDIDO</span>
          </button>
          <p className="text-center text-xs text-gray-400 mt-3">Una vez listo, espera a que todos confirmen o el host termine la ronda.</p>
        </div>

        <div className="w-full max-w-xs mt-4">
          {isHost ? (
            <div className="flex gap-2">
              <button onClick={()=>hostFinishGame()} className="flex-1 py-3 rounded-xl bg-red-600 font-bold">FINALIZAR RONDA</button>
              <button onClick={()=>hostResetReadyAll()} className="py-3 px-4 rounded-xl bg-white/10">Reset Ready</button>
            </div>
          ) : (
            <div className="text-xs text-gray-400 text-center mt-2">Esperando acciones del host...</div>
          )}
        </div>
      </div>
    );
  }

  function FinishedView(){
    const impostorUid = roomState && roomState.game && roomState.game.impostorUid;
    const impostor = players.find(p => p.uid === impostorUid);
    return (
      <div className="min-h-screen flex flex-col p-6 items-center justify-center">
        <div className="text-center mb-6">
          <div className="text-6xl mb-4">üéâ</div>
          <h1 className="text-3xl font-bold">Ronda finalizada</h1>
          <p className="text-gray-400 mt-2">Gracias por jugar</p>
        </div>

        <div className="bg-[#0f1724] p-4 rounded-xl border border-gray-800 mb-4 text-center">
          <div className="text-sm text-gray-400">Impostor</div>
          <div className="text-4xl mt-2">{impostor ? impostor.avatar : '‚Äî'}</div>
          <div className="font-semibold mt-2">{impostor ? impostor.name : 'Desconocido'}</div>
        </div>

        <div className="flex gap-2 w-full max-w-xs">
          <button onClick={()=> { if (isHost) hostStartGame(); else alert('Solo host puede iniciar otra ronda') }} className="flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 font-bold">JUGAR OTRA</button>
          <button onClick={leaveRoom} className="py-3 px-4 rounded-xl bg-white/10">Salir</button>
        </div>
      </div>
    );
  }

  if (!ready) return (<div className="min-h-screen flex items-center justify-center">Cargando...</div>);

  return (
    <>
      {(!roomId && view === 'home') && <HomeView me={me} setMe={setMe} createRoom={createRoom} joinRoom={joinRoom} roomId={roomId} />}
      {(roomId && view === 'lobby') && <LobbyView />}
      {(roomId && view === 'game') && <GameView />}
      {(roomId && view === 'finished') && <FinishedView />}
      
      <div style={{position:'fixed', right:12, bottom:12}}>
        <div className="bg-white/5 p-2 rounded-lg text-xs text-gray-300">
          {me ? <div>Tu: {me.name}</div> : null}
          <div>Room: {roomId || '-'}</div>
          {roomId && <button onClick={leaveRoom} className="text-xs mt-1 underline">Salir</button>}
        </div>
      </div>
    </>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
