<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Impostor - Edici√≥n Definitiva (Focus Fix)</title>
  
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/TuUsuario/TuRepo/main/favicon-96x96.png" sizes="96x96" />
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Canvas Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Grotesk:wght@700&display=swap');

    body { 
      font-family: 'Inter', sans-serif; 
      background: #050505; 
      color: #e6eef8; 
      margin: 0; 
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased; 
    }

    #bg-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: radial-gradient(circle at 50% 10%, #1a1f35 0%, #050505 100%);
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    }
    
    .glass-input {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      transition: all 0.3s ease;
    }
    .glass-input:focus {
      border-color: #8b5cf6;
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
      outline: none;
    }

    /* Game Card 3D */
    .card-container { 
        perspective: 1200px; 
        touch-action: none;
    }
    .game-card { 
      transform-style: preserve-3d; 
      will-change: transform; 
      touch-action: none; 
      user-select: none; 
      box-shadow: 0 20px 50px -12px rgba(0,0,0,0.8);
      cursor: pointer; 
    }
    
    .card-hidden {
        pointer-events: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }

    .animate-float { animation: float 6s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

    @keyframes pulse-gold {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.4), inset 0 0 10px rgba(255, 215, 0, 0.2); border-color: rgba(255, 215, 0, 0.6); }
      50% { box-shadow: 0 0 50px rgba(255, 215, 0, 0.8), inset 0 0 25px rgba(255, 215, 0, 0.4); border-color: #FFF; }
    }
    .turn-active {
      animation: pulse-gold 1.5s infinite;
      border: 2px solid #FFD700;
      z-index: 10;
    }

    @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-enter { animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

    @keyframes gradient-x { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .animate-gradient-text { background-size: 200% auto; animation: gradient-x 4s linear infinite; }

    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .animate-shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

    .no-scrollbar::-webkit-scrollbar{display:none} .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .font-display { font-family: 'Space Grotesk', sans-serif; }
    
    .player-not-ready { filter: grayscale(100%) opacity(0.4); transition: all 0.5s ease; }
    .player-ready { filter: grayscale(0%) opacity(1); transition: all 0.5s ease; }

  </style>
</head>
<body>
  <canvas id="bg-canvas"></canvas>
  <div id="root"></div>

  <script>
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let particles = [];

    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    class Particle {
      constructor() { this.reset(); }
      reset() {
        this.x = Math.random() * width;
        this.y = Math.random() * height;
        this.vx = (Math.random() - 0.5) * 0.5;
        this.vy = (Math.random() - 0.5) * 0.5;
        this.size = Math.random() * 2;
        this.alpha = Math.random() * 0.5 + 0.1;
      }
      update() {
        this.x += this.vx; this.y += this.vy;
        if (this.x < 0 || this.x > width) this.vx *= -1;
        if (this.y < 0 || this.y > height) this.vy *= -1;
      }
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
        ctx.fill();
      }
    }
    for (let i = 0; i < 50; i++) particles.push(new Particle());
    function animateBg() {
      ctx.clearRect(0, 0, width, height);
      particles.forEach(p => { p.update(); p.draw(); });
      requestAnimationFrame(animateBg);
    }
    animateBg();
  </script>

  <script type="text/babel">
/* ------------------------------
  Impostor Multijugador - Professional Edition v6.1 (Strong Focus Fix)
-------------------------------*/

const { useState, useEffect, useRef, useMemo } = React;

/* ---------------------- CONFIG ---------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDRGRi_Npt30Q7WfyhipyGXyk8vAeZrlCQ",
  authDomain: "impostor-5803d.firebaseapp.com",
  projectId: "impostor-5803d",
  databaseURL: "https://impostor-5803d-default-rtdb.firebaseio.com",
  messagingSenderId: "12633602652",
  appId: "1:12633602652:web:67cef779b6090b50194499",
  measurementId: "G-8575W3YWL3"
};

/* ---------------------- Setup Firebase ---------------------- */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* ---------------------- Datos ---------------------- */
const wordCategories = [
  { category: "Lugares", words: ["Hospital", "Escuela", "Playa", "Aeropuerto", "Cine", "Cementerio", "Biblioteca", "Gimnasio", "Supermercado", "Banco", "Parque de Diversiones", "Iglesia", "Museo", "C√°rcel", "Estaci√≥n de Tren", "Zool√≥gico", "Hotel", "Restaurante", "Farmacia", "Teatro", "Estadio", "Discoteca", "Casino", "Faro", "Castillo", "Cueva", "Monta√±a", "Desierto", "Selva", "Submarino", "Estaci√≥n Espacial", "Circo"] },
  { category: "Comida", words: ["Pizza", "Sushi", "Hamburguesa", "Tacos", "Helado", "Chocolate", "Ensalada", "Paella", "Espagueti", "Sopa", "Pollo Frito", "Kebab", "Burrito", "Pastel", "Fruta", "Huevo Frito", "Cereal", "Panqueques", "Donas", "Galletas", "Palomitas", "Nachos", "Queso", "Jam√≥n", "Pescado", "Mariscos", "Curry", "Ramen", "Empanada", "Arepa", "Croissant", "Churros"] },
  { category: "Animales", words: ["Elefante", "Jirafa", "Le√≥n", "Ping√ºino", "Delf√≠n", "Perro", "Gato", "Koala", "Tigre", "Oso", "√Åguila", "Tibur√≥n", "Ballena", "Serpiente", "Mono", "Canguro", "Cocodrilo", "Tortuga", "Caballo", "Vaca", "Cerdo", "Oveja", "Conejo", "Rat√≥n", "Murci√©lago", "B√∫ho", "Lobo", "Zorro", "Panda", "Loro", "Camello", "Hipop√≥tamo"] },
  { category: "Objetos", words: ["Tel√©fono", "Cuchara", "Reloj", "Silla", "L√°mpara", "Zapato", "Guitarra", "Espejo", "Libro", "Llaves", "Gafas", "Botella", "Cuchillo", "Tenedor", "Plato", "Vaso", "Computadora", "Televisi√≥n", "C√°mara", "Mochila", "Bicicleta", "Coche", "Almohada", "Cama", "Cepillo de Dientes", "Peine", "Tijeras", "Martillo", "Destornillador", "Pincel", "L√°piz", "Cuaderno", "Paraguas", "Billetera"] },
  { category: "Profesiones", words: ["Doctor", "Polic√≠a", "Bombero", "Profesor", "Astronauta", "Cocinero", "Payaso", "Mec√°nico", "Dentista", "Enfermero", "Piloto", "Juez", "Abogado", "Carpintero", "Electricista", "Pintor", "Escritor", "M√∫sico", "Actor", "Cantante", "Bailar√≠n", "Granjero", "Pescador", "Soldado", "Cient√≠fico", "Detective", "Mago", "Arquitecto", "Veterinario", "Fot√≥grafo", "Periodista", "Atleta"] }
];

const avatars = ["üëΩ","üëª","ü§ñ","ü§°","üëπ","ü§†","üòé","ü¶Ñ","üê≤","üéÉ","üêØ","üê∂","ü¶ä","ü¶Å","üë∫","üëæ"];

/* ---------------------- Utils ---------------------- */
const uidKey = 'impostor_uid_v2';
const playerLSkey = 'impostor_player_v2';
const roomLSkey = 'impostor_room_v2';

function makeRoomId() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s=''; for(let i=0;i<4;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

function shuffleArray(array) {
  let currentIndex = array.length, randomIndex;
  while (currentIndex != 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
  }
  return array;
}

function saveLS(key, value){ try{ localStorage.setItem(key, JSON.stringify(value)); } catch(e){} }
function loadLS(key, fallback){ try { const v = localStorage.getItem(key); return v?JSON.parse(v):fallback;}catch(e){return fallback;} }

/* ---------------------- Auth ---------------------- */
async function ensureAuth() {
  let user = auth.currentUser;
  if (!user) {
    try {
      const result = await auth.signInAnonymously();
      user = result.user;
      saveLS(uidKey, user.uid);
    } catch (err) {
      let fallbackId = loadLS(uidKey, null);
      if (!fallbackId) {
        fallbackId = 'anon_' + Math.random().toString(36).slice(2,10);
        saveLS(uidKey, fallbackId);
      }
      return { uid: fallbackId, fallback:true };
    }
  }
  return { uid: user.uid, fallback:false };
}

/* ---------------------- UI Components ---------------------- */
function Button({ onClick, children, variant = 'primary', className = '', disabled = false }) {
  const baseStyle = "w-full py-4 rounded-2xl font-bold transition-all duration-200 transform active:scale-95 flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-gradient-to-r from-violet-600 to-fuchsia-600 shadow-[0_0_20px_rgba(124,58,237,0.5)] hover:shadow-[0_0_30px_rgba(124,58,237,0.7)] text-white",
    secondary: "glass-panel hover:bg-white/10 text-white",
    danger: "bg-gradient-to-r from-red-600 to-rose-600 shadow-[0_0_20px_rgba(225,29,72,0.5)] text-white",
    gold: "bg-gradient-to-r from-amber-400 to-orange-500 shadow-[0_0_20px_rgba(251,191,36,0.5)] text-black",
    disabled: "bg-gray-800/50 text-gray-500 cursor-not-allowed"
  };
  return (
    <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${disabled ? variants.disabled : variants[variant]} ${className}`}>
      {children}
    </button>
  );
}

function HomeView({ me, setMe, createRoom, joinRoom, roomId }){
  const [joinCode, setJoinCode] = useState('');
  const [joinName, setJoinName] = useState(me ? me.name : '');

  return (
    <div className="min-h-screen flex flex-col p-6 items-center justify-center relative animate-enter">
      <div className="text-center mb-10">
        <div className="text-6xl mb-2 animate-float">üïµÔ∏è</div>
        <h1 className="text-5xl font-display font-black text-transparent bg-clip-text bg-gradient-to-r from-violet-400 via-pink-500 to-orange-400 animate-gradient-text">
          IMPOSTOR
        </h1>
        <p className="text-gray-400 mt-2 font-medium tracking-wide">ENGA√ëA ‚Ä¢ PIENSA ‚Ä¢ DISCUTE</p>
      </div>

      <div className="w-full max-w-sm space-y-6">
        <div className="glass-panel p-6 rounded-3xl relative overflow-hidden group">
          <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-violet-500 to-pink-500"></div>
          <div className="flex items-center gap-4 relative z-10">
            <div className="text-4xl p-3 bg-white/5 rounded-2xl border border-white/10 shadow-inner">
              {me && me.avatar}
            </div>
            <div className="flex-1">
              <label className="text-xs text-gray-400 font-semibold uppercase tracking-wider mb-1 block">Tu Nombre</label>
              <input
                value={me ? me.name : ''}
                onChange={(e)=>{
                  const nm = e.target.value;
                  const newMe = {...me, name:nm};
                  setMe(newMe);
                  saveLS(playerLSkey, newMe);
                }}
                className="w-full bg-transparent border-none text-xl font-bold focus:ring-0 p-0 text-white placeholder-gray-600"
                placeholder="Ingresa tu nombre"
              />
            </div>
          </div>
        </div>

        <Button onClick={createRoom}><span>CREAR SALA NUEVA</span></Button>

        <div className="glass-panel p-1 rounded-3xl flex items-center pr-1">
          <input 
            value={joinCode} 
            onChange={(e)=>setJoinCode(e.target.value.toUpperCase())} 
            placeholder="C√ìDIGO DE SALA" 
            className="flex-1 bg-transparent border-none text-center font-mono text-lg font-bold tracking-widest py-3 focus:ring-0 text-white placeholder-gray-600" 
          />
          <button onClick={()=>joinRoom(joinCode, joinName || (me && me.name))} className="bg-white/10 hover:bg-white/20 text-white p-3 rounded-2xl transition-colors">
            ENTRAR
          </button>
        </div>
      </div>
    </div>
  );
}

/* ---------------------- App Component ---------------------- */
function App(){
  const [ready, setReady] = useState(false);
  const [me, setMe] = useState(loadLS(playerLSkey, null)); 
  const [roomId, setRoomId] = useState(loadLS(roomLSkey, null));
  const [view, setView] = useState('home'); 
  const [roomState, setRoomState] = useState(null); 
  const [players, setPlayers] = useState([]); 
  const [localRole, setLocalRole] = useState(null); 
  const [secretWord, setSecretWord] = useState('');
  const [category, setCategory] = useState('');
  const [isHost, setIsHost] = useState(false);
  const [turnOrder, setTurnOrder] = useState([]);
  const [currentTurnIndex, setCurrentTurnIndex] = useState(0);
  const [statements, setStatements] = useState({});
  const [votingState, setVotingState] = useState(null);
  const [gameStartedAt, setGameStartedAt] = useState(0); 

  // Swipe logic
  const cardFrontRef = useRef(null);
  const cardBackRef = useRef(null);
  const containerRef = useRef(null);
  const startYRef = useRef(0);
  const draggingRef = useRef(false);
  const [cardRevealed, setCardRevealed] = useState(false);
  const [containerHeight, setContainerHeight] = useState(420);
  
  const roomRef = useRef(null);
  const playersRef = useRef(null);
  const gameRef = useRef(null);

  useEffect(()=> {
    (async ()=> {
      const authRes = await ensureAuth();
      let myPlayer = me;
      if (!myPlayer) {
        const name = 'Jugador ' + Math.floor(Math.random()*900+100);
        const avatar = avatars[Math.floor(Math.random()*avatars.length)];
        myPlayer = { uid: authRes.uid, name, avatar };
        saveLS(playerLSkey, myPlayer);
        setMe(myPlayer);
      } else {
        myPlayer.uid = authRes.uid || myPlayer.uid;
        saveLS(playerLSkey, myPlayer);
        setMe(myPlayer);
      }
      setReady(true);
    })();
  }, []);

  useEffect(()=> {
    if (!ready) return;
    cleanupRoomListeners();
    if (!roomId) {
      setRoomState(null);
      setPlayers([]);
      setView('home');
      return;
    }
    roomRef.current = db.ref('rooms/' + roomId);
    playersRef.current = db.ref('rooms/' + roomId + '/players');
    gameRef.current = db.ref('rooms/' + roomId + '/game');

    roomRef.current.child('meta').on('value', snap => {
      const val = snap.val();
      setRoomState(prev => ({ ...prev, meta: val }));
      if (val && val.hostUid === (me && me.uid)) setIsHost(true); else setIsHost(false);
    });

    playersRef.current.on('value', snap => {
      const obj = snap.val() || {};
      const arr = Object.keys(obj).map(k => ({ uid: k, ...obj[k] }));
      arr.sort((a,b) => (a.joinedAt||0) - (b.joinedAt||0));
      setPlayers(arr);
    });

    gameRef.current.on('value', snap => {
      const val = snap.val();
      setRoomState(prev => ({ ...prev, game: val }));
      if (val) {
        setCategory(val.category || '');
        setSecretWord(val.word || '');
        setTurnOrder(val.turnOrder || []);
        setCurrentTurnIndex(val.turnIndex || 0);
        setStatements(val.statements || {});
        
        if (val.startedAt && val.startedAt !== gameStartedAt) {
            setGameStartedAt(val.startedAt);
            setCardRevealed(false); 
        }

        if (val.state === 'playing') {
          setView('game');
          if (val.roles && me && me.uid) {
            setLocalRole(val.roles[me.uid] ? val.roles[me.uid].role : null);
          }
        } else if (val.state === 'voting') {
          setView('voting');
          setVotingState(val.voting || {});
        } else if (val.state === 'finished') {
          setView('finished');
        } else {
          setView('lobby');
          setCardRevealed(false);
          setLocalRole(null);
        }
      } else {
        setView('lobby');
      }
    });

    saveLS(roomLSkey, roomId);
    return () => cleanupRoomListeners();
  }, [roomId, ready, me && me.uid, gameStartedAt]);

  function cleanupRoomListeners() {
    if (roomRef.current) { roomRef.current.off(); }
    if (playersRef.current) { playersRef.current.off(); }
    if (gameRef.current) { gameRef.current.off(); }
  }

  async function createRoom() {
    const id = makeRoomId();
    await db.ref('rooms/' + id + '/meta').set({ hostUid: me.uid, createdAt: Date.now() });
    await db.ref('rooms/' + id + '/players/' + me.uid).set({ name: me.name, avatar: me.avatar, joinedAt: Date.now() });
    await db.ref('rooms/' + id + '/game').set({ state: 'lobby' });
    setRoomId(id);
    setIsHost(true);
    setView('lobby');
  }

  async function joinRoom(code, name) {
    if (!code) return alert('C√≥digo vac√≠o');
    const s = await db.ref('rooms/' + code + '/meta').get();
    if (!s.exists()) return alert('Sala no existe');
    await db.ref('rooms/' + code + '/players/' + me.uid).set({ name, avatar: me.avatar, joinedAt: Date.now() });
    setRoomId(code);
    setView('lobby');
  }

  async function leaveRoom() {
    if (roomId) await db.ref('rooms/' + roomId + '/players/' + me.uid).remove();
    setRoomId(null); setView('home');
  }

  async function hostStartGame() {
    if (!isHost) return;
    const cat = wordCategories[Math.floor(Math.random() * wordCategories.length)];
    const word = cat.words[Math.floor(Math.random() * cat.words.length)];
    const uids = players.map(p => p.uid);
    if (uids.length < 3) return alert('M√≠nimo 3 jugadores');
    
    const impUid = uids[Math.floor(Math.random() * uids.length)];
    const roles = {};
    uids.forEach(u => roles[u] = { role: u === impUid ? 'impostor' : 'word' });

    const newTurnOrder = shuffleArray([...uids]);
    const updates = {};
    uids.forEach(u => updates['players/'+u+'/ready'] = false);
    updates['game'] = {
      state: 'playing',
      startedAt: Date.now(), 
      category: cat.category,
      word: word,
      impostorUid: impUid,
      roles: roles,
      turnOrder: newTurnOrder,
      turnIndex: 0,
      statements: {} 
    };
    
    await db.ref('rooms/' + roomId).update(updates);
  }

  async function hostStartVoting() {
    if (!isHost) return;
    const endTime = Date.now() + 60000; 
    await db.ref('rooms/' + roomId + '/game').update({
      state: 'voting',
      voting: { endTime: endTime, votes: {} }
    });
  }

  async function submitVote(targetUid) {
    if (votingState && votingState.votes && votingState.votes[me.uid]) return; 
    await db.ref('rooms/' + roomId + '/game/voting/votes/' + me.uid).set(targetUid);
  }

  async function hostSubmitStatement(text) {
    if (!isHost || !text.trim()) return;
    const currentUid = turnOrder[currentTurnIndex];
    if (!currentUid) return;

    await db.ref('rooms/' + roomId + '/game/statements').push({
        uid: currentUid,
        text: text,
        timestamp: Date.now()
    });

    const nextIdx = (currentTurnIndex + 1) % turnOrder.length;
    await db.ref('rooms/' + roomId + '/game/turnIndex').set(nextIdx);
  }

  useEffect(() => {
    const update = () => { if(containerRef.current) setContainerHeight(containerRef.current.getBoundingClientRect().height); };
    update(); window.addEventListener('resize', update);
    return ()=> window.removeEventListener('resize', update);
  }, []);

  function onPointerDown(ev){
    if (cardRevealed) return;
    draggingRef.current = true;
    startYRef.current = ev.clientY ?? (ev.touches && ev.touches[0].clientY) ?? 0;
  }
  
  function onPointerMove(ev){
    if (!draggingRef.current || cardRevealed) return;
    const cy = ev.clientY ?? (ev.touches && ev.touches[0].clientY) ?? 0;
    const delta = cy - startYRef.current;
    const ty = Math.min(0, delta);
    
    if (ty < 0 && cardFrontRef.current) {
        const rotateX = (ty / containerHeight) * 20; 
        cardFrontRef.current.style.transition = 'none';
        cardFrontRef.current.style.transform = `translateY(${ty}px) rotateX(${rotateX}deg) scale(${1 - Math.abs(ty)/1000})`;
        
        if (cardBackRef.current) {
            const progress = Math.min(1, Math.abs(ty) / (containerHeight * 0.3));
            cardBackRef.current.style.opacity = progress;
            cardBackRef.current.style.transform = `scale(${0.9 + (0.1*progress)})`;
        }
    }
    if (ty < -(containerHeight * 0.25)) {
      draggingRef.current = false;
      revealLocalCard();
    }
  }

  function onPointerUp(){
    if (cardRevealed) return;
    if (!draggingRef.current) return;
    draggingRef.current = false;
    
    if (cardFrontRef.current) {
        cardFrontRef.current.style.transition = 'transform 0.5s elastic';
        cardFrontRef.current.style.transform = 'translateY(0px) rotateX(0deg)';
    }
    if (cardBackRef.current) {
        cardBackRef.current.style.opacity = '0';
    }
  }

  function revealLocalCard(){
    if(cardRevealed) return;
    setCardRevealed(true);
    db.ref('rooms/' + roomId + '/players/' + me.uid + '/ready').set(true);
  }

  /* --- VISTAS --- */

  function LobbyView(){
    return (
      <div className="min-h-screen flex flex-col p-6 items-center animate-enter w-full max-w-[95vw] mx-auto">
        <div className="w-full max-w-lg mx-auto flex justify-between items-center mb-6">
          <div className="flex flex-col">
            <span className="text-gray-400 text-xs font-bold tracking-widest uppercase">C√ìDIGO DE SALA</span>
            <span className="text-4xl font-mono font-black text-white">{roomId}</span>
          </div>
          <span className="text-sm font-semibold bg-violet-500/20 text-violet-300 px-3 py-1 rounded-full border border-violet-500/30">
            {isHost ? 'ERES EL HOST' : 'ESPERANDO...'}
          </span>
        </div>

        <div className="w-full max-w-lg mx-auto glass-panel rounded-3xl p-5 mb-6 flex-1 flex flex-col">
          <h3 className="font-bold text-gray-300 mb-4 border-b border-white/5 pb-2">JUGADORES ({players.length})</h3>
          <div className="space-y-3 overflow-y-auto no-scrollbar flex-1">
            {players.map((p) => (
              <div key={p.uid} className="flex items-center gap-4 bg-black/20 p-3 rounded-2xl border border-white/5">
                <div className="text-3xl">{p.avatar}</div>
                <div className="font-bold text-white">{p.name} {p.uid === me.uid && '(T√∫)'}</div>
              </div>
            ))}
          </div>
        </div>

        <div className="w-full max-w-lg mx-auto">
            {isHost ? (
            <Button onClick={hostStartGame}>INICIAR PARTIDA</Button>
            ) : (
            <div className="text-center p-4 text-gray-400 animate-pulse">El host iniciar√° pronto...</div>
            )}
            <Button variant="secondary" className="mt-3" onClick={leaveRoom}>Salir</Button>
        </div>
      </div>
    );
  }

  function GameView(){
    const currentPlayer = players.find(p => p.uid === me.uid) || me;
    const isImpostor = localRole === 'impostor';
    const turnUid = turnOrder[currentTurnIndex];
    const turnPlayer = players.find(p => p.uid === turnUid);
    const [wordInput, setWordInput] = useState('');
    const hostInputRef = useRef(null);

    const isMyTurn = turnUid === me.uid;

    /* MEJORA 1: ORDENAR JUGADORES POR TURNO */
    const sortedPlayers = useMemo(() => {
        if (!turnOrder || turnOrder.length === 0) return players;
        const sorted = [...players];
        sorted.sort((a, b) => {
            const idxA = turnOrder.indexOf(a.uid);
            const idxB = turnOrder.indexOf(b.uid);
            const valA = idxA === -1 ? 9999 : idxA;
            const valB = idxB === -1 ? 9999 : idxB;
            return valA - valB;
        });
        return sorted;
    }, [players, turnOrder]);

    const handleInputKey = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (!wordInput.trim()) return;
            
            hostSubmitStatement(wordInput);
            setWordInput('');
            
            // FOCUS FORCE STRATEGY
            if(hostInputRef.current) hostInputRef.current.focus();
            setTimeout(() => { if(hostInputRef.current) hostInputRef.current.focus(); }, 10);
            setTimeout(() => { if(hostInputRef.current) hostInputRef.current.focus(); }, 50);
        }
    };

    const handleSendClick = () => {
        if (!wordInput.trim()) return;
        hostSubmitStatement(wordInput);
        setWordInput('');
        if(hostInputRef.current) hostInputRef.current.focus();
        setTimeout(() => { if(hostInputRef.current) hostInputRef.current.focus(); }, 50);
    };

    return (
      <div className={`min-h-screen flex flex-col transition-all duration-1000 ${!cardRevealed ? 'bg-black/80 backdrop-blur-md' : ''}`}>
        
        {/* Navbar */}
        <div className="w-full p-4 flex justify-between items-center bg-black/20 backdrop-blur-md sticky top-0 z-50 border-b border-white/5">
            <div className="flex items-center gap-2">
                <span className="text-2xl">{currentPlayer.avatar}</span>
                <div className="leading-none">
                    <div className="text-[10px] text-gray-400 uppercase tracking-wider">Tu Rol</div>
                    <div className={`font-bold ${cardRevealed ? (isImpostor ? 'text-red-500' : 'text-blue-400') : 'text-white'}`}>
                        {cardRevealed ? (isImpostor ? 'IMPOSTOR' : 'TRIPULANTE') : '???'}
                    </div>
                </div>
            </div>
            
            {turnPlayer && (
                <div className="flex flex-col items-end">
                    <span className="text-[10px] text-amber-400 uppercase tracking-widest font-bold">Turno de</span>
                    <div className="flex items-center gap-1">
                        <span className="text-white font-bold">{turnPlayer.name}</span>
                        {isMyTurn && <span className="bg-amber-500 text-black text-[10px] px-1 rounded font-bold animate-pulse">YO</span>}
                    </div>
                </div>
            )}
        </div>

        {/* LAYOUT FLUIDO ULTRAWIDE */}
        <div className="flex-1 w-full max-w-[95vw] mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            
            {/* LISTA JUGADORES (ORDENADA) */}
            <div className="hidden lg:flex lg:col-span-3 xl:col-span-3 flex-col gap-3 h-[calc(100vh-100px)] overflow-y-auto no-scrollbar glass-panel rounded-3xl p-4">
                <h3 className="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Tripulaci√≥n (Orden de Turno)</h3>
                {sortedPlayers.map((p, idx) => {
                    const isTurn = p.uid === turnUid;
                    const userWords = Object.values(statements).filter(s => s.uid === p.uid).map(s => s.text);
                    
                    return (
                        <div key={p.uid} className={`relative p-3 rounded-2xl border transition-all duration-300
                            ${isTurn ? 'turn-active bg-amber-500/10' : 'border-white/5 bg-white/5'}
                            ${!p.ready ? 'player-not-ready' : 'player-ready'}
                        `}>
                             <div className="absolute top-2 right-2 text-[10px] text-gray-600 font-mono">#{idx + 1}</div>
                             
                            <div className="flex items-center gap-3">
                                <div className="text-2xl">{p.avatar}</div>
                                <div className="flex-1 min-w-0">
                                    <div className="font-bold text-white truncate">{p.name}</div>
                                    <div className="flex flex-wrap gap-1 mt-1">
                                        {userWords.map((w,i) => (
                                            <span key={i} className="text-[10px] bg-white/10 px-1.5 py-0.5 rounded text-gray-300">{w}</span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>

            {/* CARTA CENTRAL */}
            <div className="lg:col-span-6 xl:col-span-6 flex flex-col items-center justify-center relative min-h-[500px]">
                
                <div ref={containerRef} className="w-full max-w-md h-[480px] relative card-container z-20" 
                    onPointerDown={onPointerDown} onPointerMove={onPointerMove} onPointerUp={onPointerUp} onPointerCancel={onPointerUp}>
                    
                    {/* CARTA FRONTAL (Cover) */}
                    <div ref={cardFrontRef} 
                         onClick={revealLocalCard}
                         className={`game-card absolute inset-0 rounded-[2.5rem] border border-white/10 flex flex-col items-center justify-center bg-[#0f1119] overflow-hidden shadow-2xl transition-opacity duration-500 ${cardRevealed ? 'card-hidden' : ''}`}>
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div className="relative z-10 flex flex-col items-center pointer-events-none">
                            <div className="text-9xl mb-8 animate-float">{currentPlayer.avatar}</div>
                            <div className="text-center px-6">
                                <p className="text-white font-bold text-2xl mb-1">¬°Toca para Ver!</p>
                                <p className="text-gray-400 text-sm mb-4">Click o Desliza</p>
                                <div className="w-1 h-12 bg-gradient-to-t from-violet-500 to-transparent mx-auto rounded-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>

                    {/* CARTA TRASERA (ROL) */}
                    <div ref={cardBackRef} className={`absolute inset-0 flex flex-col items-center justify-center rounded-[2.5rem] border transition-all duration-500
                        ${cardRevealed ? 'opacity-100 scale-100' : 'opacity-0 scale-90'}
                        ${isImpostor ? 'bg-gradient-to-br from-red-950 to-black border-red-500/30' : 'bg-gradient-to-br from-blue-950 to-black border-blue-500/30'}
                        ${isMyTurn ? 'turn-active' : ''}
                        `}>
                        
                        {isImpostor ? (
                            <div className="text-center p-6 animate-shake">
                                <div className="text-9xl mb-6">ü§´</div>
                                <h2 className="text-5xl font-black text-red-500 mb-4">IMPOSTOR</h2>
                                <p className="text-red-200 text-lg bg-red-900/20 p-4 rounded-xl">Enga√±a a todos. No sabes la palabra.</p>
                            </div>
                        ) : (
                            <div className="text-center p-6">
                                <div className="text-8xl mb-6">üõ°Ô∏è</div>
                                <h2 className="text-sm font-bold text-blue-400 tracking-[0.3em] uppercase mb-4">Palabra Secreta</h2>
                                <div className="bg-white/5 p-8 rounded-3xl w-full backdrop-blur-sm mb-6">
                                    <h1 className="text-4xl font-black text-white">{secretWord}</h1>
                                </div>
                                <span className="text-sm text-blue-300 bg-blue-900/20 px-4 py-1.5 rounded-full">{category}</span>
                            </div>
                        )}

                        {isMyTurn && (
                            <div className="absolute -bottom-12 bg-amber-500 text-black font-bold px-6 py-2 rounded-full shadow-[0_0_20px_rgba(255,191,0,0.8)] animate-bounce text-base">
                                ¬°ES TU TURNO DE HABLAR!
                            </div>
                        )}
                    </div>
                </div>

                {/* Lista Movil (Ahora tambien ordenada) */}
                <div className="lg:hidden w-full mt-10 space-y-2">
                    {cardRevealed && sortedPlayers.map(p => {
                        const isTurn = p.uid === turnUid;
                        const userWords = Object.values(statements).filter(s => s.uid === p.uid).map(s => s.text);
                        return (
                             <div key={p.uid} className={`p-3 rounded-xl border flex items-center gap-3 transition-all ${isTurn ? 'turn-active bg-amber-500/10' : 'bg-white/5 border-white/5'} ${!p.ready ? 'player-not-ready':''}`}>
                                <div className="text-xl">{p.avatar}</div>
                                <div className="flex-1">
                                    <div className="font-bold text-sm text-white flex justify-between">
                                        {p.name}
                                        {isTurn && <span className="text-[10px] text-amber-400 animate-pulse">HABLANDO...</span>}
                                    </div>
                                    <div className="flex flex-wrap gap-1 mt-1">
                                         {userWords.length > 0 ? (
                                            userWords.map((w,i)=><span key={i} className="text-[10px] text-gray-300 bg-white/10 px-1 rounded">{w}</span>)
                                         ) : <span className="text-[10px] text-gray-600 italic">...</span>}
                                    </div>
                                </div>
                             </div>
                        );
                    })}
                </div>
            </div>

            {/* PANEL HOST (Flexible) */}
            <div className="lg:col-span-3 xl:col-span-3 flex flex-col gap-4 h-full justify-between">
                {isHost && cardRevealed && (
                    <div className="glass-panel p-4 rounded-2xl border-l-4 border-l-amber-500">
                        <div className="text-xs font-bold text-amber-500 uppercase mb-2">Panel de Host</div>
                        {turnPlayer ? (
                            <>
                                <p className="text-sm text-gray-300 mb-2">Escribe lo que diga <b className="text-white">{turnPlayer.name}</b>:</p>
                                <div className="flex gap-2">
                                    <input 
                                        ref={hostInputRef}
                                        type="text" 
                                        autoFocus
                                        value={wordInput}
                                        onChange={(e) => setWordInput(e.target.value)}
                                        onKeyDown={handleInputKey}
                                        className="flex-1 bg-black/30 border border-white/20 rounded-xl px-3 text-white focus:border-amber-500 outline-none"
                                        placeholder="Escribe y presiona Enter..."
                                    />
                                    <button 
                                        onClick={handleSendClick}
                                        className="bg-amber-500 text-black font-bold px-4 rounded-xl hover:bg-amber-400"
                                    >
                                        OK
                                    </button>
                                </div>
                                <button onClick={() => hostSubmitStatement("Pas√≥ turno")} className="text-[10px] text-gray-500 underline mt-2">Saltar Turno</button>
                            </>
                        ) : (
                            <p className="text-sm text-gray-500">Esperando inicio...</p>
                        )}
                    </div>
                )}

                {isHost && (
                    <div className="grid grid-cols-2 gap-2 mt-4 lg:mt-auto">
                        <Button variant="danger" className="text-xs py-3" onClick={hostStartVoting}>INICIAR VOTACI√ìN</Button>
                        <Button variant="secondary" className="text-xs py-3" onClick={()=>db.ref('rooms/'+roomId+'/game/state').set('finished')}>TERMINAR</Button>
                    </div>
                )}
            </div>
        </div>
      </div>
    );
  }

  /* 4. VOTACI√ìN EN TIEMPO REAL */
  function VotingView() {
    const [timeLeft, setTimeLeft] = useState(60);
    const hasVoted = votingState && votingState.votes && votingState.votes[me.uid];
    const currentVotes = votingState?.votes || {};

    useEffect(() => {
        if (!isHost || !votingState || !votingState.votes) return;
        const votesCount = Object.keys(votingState.votes).length;
        if (votesCount >= players.length && players.length > 0) {
            db.ref('rooms/'+roomId+'/game/state').set('finished');
        }
    }, [votingState, players.length, isHost]);

    useEffect(() => {
        if (!votingState || !votingState.endTime) return;
        const interval = setInterval(() => {
            const seconds = Math.max(0, Math.ceil((votingState.endTime - Date.now()) / 1000));
            setTimeLeft(seconds);
            if (seconds === 0 && !hasVoted) {
                submitVote(me.uid);
            }
        }, 1000);
        return () => clearInterval(interval);
    }, [votingState, hasVoted]);

    const myVoteTarget = votingState?.votes?.[me.uid];

    return (
        <div className="min-h-screen flex flex-col p-6 items-center justify-center animate-enter">
            <h1 className="text-3xl font-black text-white mb-2">MOMENTO DE VOTAR</h1>
            <div className={`text-6xl font-mono font-bold mb-8 ${timeLeft < 10 ? 'text-red-500 animate-pulse' : 'text-white'}`}>
                {timeLeft}s
            </div>
            
            <p className="text-gray-400 mb-6 text-sm max-w-xs text-center">
                Si no votas antes de que acabe el tiempo (o todos voten), te votar√°s a ti mismo.
            </p>

            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 w-full max-w-[90vw]">
                {players.map(p => {
                    const isSelected = myVoteTarget === p.uid;
                    const userWords = Object.values(statements).filter(s => s.uid === p.uid).map(s => s.text);
                    const votersForThisPlayer = players.filter(voter => currentVotes[voter.uid] === p.uid);

                    return (
                        <button 
                            key={p.uid} 
                            onClick={() => !hasVoted && submitVote(p.uid)}
                            disabled={hasVoted}
                            className={`relative p-6 rounded-3xl border flex flex-col items-center transition-all
                                ${isSelected ? 'bg-red-600 border-red-400 transform scale-105 shadow-[0_0_30px_rgba(220,38,38,0.5)] z-10' : 'bg-white/5 border-white/10 hover:bg-white/10'}
                                ${hasVoted && !isSelected ? 'opacity-50 grayscale' : ''}
                            `}
                        >
                            <div className="text-5xl mb-3">{p.avatar}</div>
                            <div className="font-bold text-white text-lg">{p.name}</div>
                            <div className="mt-2 flex flex-wrap justify-center gap-1 opacity-70">
                                {userWords.map((w,i)=><span key={i} className="text-[10px] bg-black/30 px-1 rounded">{w}</span>)}
                            </div>
                            
                            {votersForThisPlayer.length > 0 && (
                                <div className="absolute -top-3 -right-3 flex flex-wrap justify-end gap-1 w-full px-4 pointer-events-none">
                                    {votersForThisPlayer.map(v => (
                                        <div key={v.uid} className="w-8 h-8 rounded-full bg-white text-black flex items-center justify-center text-sm shadow-lg border-2 border-red-500 z-20" title={`Voto de ${v.name}`}>
                                            {v.avatar}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {isSelected && <div className="absolute top-2 right-2 text-white bg-black/50 rounded-full p-1 text-xs">TU VOTO</div>}
                        </button>
                    )
                })}
            </div>
            
            {hasVoted && <div className="mt-8 text-green-400 font-bold animate-pulse">¬°ESPERANDO A LOS DEM√ÅS!</div>}
        </div>
    )
  }

  /* 5. RESULTADOS DETALLADOS */
  function FinishedView(){
    const impostorUid = roomState?.game?.impostorUid;
    const impostor = players.find(p => p.uid === impostorUid);
    const votes = roomState?.game?.voting?.votes || {};
    
    const detailedVotes = {};
    players.forEach(p => detailedVotes[p.uid] = []);
    Object.keys(votes).forEach(voterUid => {
        const targetUid = votes[voterUid];
        if (detailedVotes[targetUid]) {
            detailedVotes[targetUid].push(players.find(p => p.uid === voterUid));
        }
    });

    useEffect(() => {
        if (window.confetti) {
            window.confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
    }, []);

    return (
      <div className="min-h-screen flex flex-col p-6 items-center justify-center animate-enter relative">
        <div className="text-center mb-8 relative z-10">
          <h1 className="text-4xl font-black text-white">RESULTADOS</h1>
        </div>

        <div className="flex flex-col lg:flex-row gap-8 items-center lg:items-start max-w-[90vw] w-full justify-center">
            
            <div className="glass-panel p-8 rounded-3xl border border-red-500/30 text-center relative w-full max-w-sm">
                <div className="text-xs font-bold text-red-400 uppercase tracking-widest mb-4">El Impostor Era</div>
                <div className="text-8xl mb-4 animate-bounce">{impostor?.avatar || '?'}</div>
                <div className="text-3xl font-bold text-white mb-2">{impostor?.name || 'Desconocido'}</div>
                <div className="text-sm text-gray-400 bg-white/5 p-3 rounded-xl inline-block">Palabra secreta: <span className="text-white font-bold">{secretWord}</span></div>
            </div>

            <div className="w-full max-w-md">
                <h3 className="text-xs text-gray-500 font-bold uppercase mb-4 text-center lg:text-left">Detalle de Votaciones</h3>
                <div className="space-y-3">
                    {players.map(p => {
                        const voters = detailedVotes[p.uid] || [];
                        if (voters.length === 0) return null;
                        
                        const isTargetImpostor = p.uid === impostorUid;

                        return (
                            <div key={p.uid} className={`bg-white/5 p-4 rounded-2xl border ${isTargetImpostor ? 'border-red-500/30 bg-red-500/5' : 'border-white/5'}`}>
                                <div className="flex justify-between items-center mb-2">
                                    <div className="flex items-center gap-3">
                                        <span className="text-2xl">{p.avatar}</span>
                                        <span className="font-bold text-white">{p.name}</span>
                                    </div>
                                    <div className="bg-white/10 px-2 py-1 rounded text-xs font-bold">{voters.length} Votos</div>
                                </div>
                                
                                <div className="flex flex-wrap gap-2 pl-2 border-l-2 border-white/10 ml-2">
                                    <span className="text-[10px] text-gray-500 uppercase tracking-widest self-center mr-1">Votado por:</span>
                                    {voters.map(v => (
                                        <div key={v.uid} className="flex items-center gap-1 bg-black/30 px-2 py-1 rounded-full border border-white/5" title={v.name}>
                                            <span className="text-xs">{v.avatar}</span>
                                            <span className="text-[10px] text-gray-300">{v.name}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )
                    })}
                </div>
            </div>
        </div>

        <div className="mt-10 text-center">
            {isHost ? (
                <Button onClick={hostStartGame} className="px-8">JUGAR OTRA VEZ</Button>
            ) : (
                <div className="p-4 bg-white/5 rounded-2xl border border-white/10 animate-pulse inline-flex items-center gap-3">
                    <span className="text-2xl">‚è≥</span>
                    <span className="text-gray-300 font-bold">Esperando al Host para la siguiente ronda...</span>
                </div>
            )}
            <div className="mt-4">
                 <button onClick={leaveRoom} className="text-gray-500 hover:text-white transition-colors text-sm underline">Salir al Inicio</button>
            </div>
        </div>
      </div>
    );
  }

  if (!ready) return <div className="min-h-screen flex items-center justify-center text-white font-bold">CARGANDO...</div>;

  return (
    <>
      {(!roomId && view === 'home') && <HomeView me={me} setMe={setMe} createRoom={createRoom} joinRoom={joinRoom} roomId={roomId} />}
      {(roomId && view === 'lobby') && <LobbyView />}
      {(roomId && view === 'game') && <GameView />}
      {(roomId && view === 'voting') && <VotingView />}
      {(roomId && view === 'finished') && <FinishedView />}
    </>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
